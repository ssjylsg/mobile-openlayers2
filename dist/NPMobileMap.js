window.NPMobile={ISPOINTCONVERT:!0,VERSION:"1.0.9",inherits:function(e,t){var r=t.prototype,a=e.prototype;for(var o in r)a[o]=r[o];a.uber=r,e.prototype.constructor=e}},function(){"use strict";var e={ALL:0,TRACE:1,DEBUG:2,INFO:3,WARN:4,ERROR:5,OFF:100},t=function(){this.level=e.DEBUG};t.prototype={log:function(t,r){if(this.level<=t)try{switch(t){case e.DEBUG:console.debug(r);break;case e.ERROR:console.error(r);break;case e.WARN:console.warn(r);break;default:console.log(r)}}catch(e){}},trace:function(t){this.log(e.TRACE,t)},debug:function(t){this.log(e.DEBUG,t)},info:function(t){this.log(e.INFO,t)},warn:function(t){this.log(e.WARN,t)},error:function(t){this.log(e.ERROR,t)}},window.NPMobile.logger=new t,window.NPMobile.Logging={Logger:t,Level:e}}(),NPMobile.Geometry={},NPMobile.Util={},NPMobile.Util.clone=function(e,t){if(null==e||"object"!=typeof e)return e;if(e.constructor!=Object&&e.constructor!=Array)return e;if(e.constructor==Date||e.constructor==RegExp||e.constructor==Function||e.constructor==String||e.constructor==Number||e.constructor==Boolean)return new e.constructor(e);t=t||new e.constructor;for(var r in e)t[r]="undefined"==typeof t[r]?NPMobile.Util.clone(e[r],null):t[r];return t},NPMobile.Util.extend=function(e,t){e=e||{};for(var r in t)void 0===e[r]&&(e[r]=NPMobile.Util.clone(t[r]));return e},NPMobile.Layers={LAYERID:0},NPMobile.Layers.Layer=function(e){this.id=null},NPMobile.Layers.Layer.prototype={display:function(e){this._layer.display(e)},getId:function(){return this.id}},NPMobile.Geometry.Curve=function(){this._vector=null,this.id=null},NPMobile.Geometry.Curve.prototype={_castPoints:function(e){if(!e)return[];for(var t,r=[],a=0;a<e.length;++a)t=e[a],r.push(new OpenLayers.Geometry.Point(t.lon,t.lat));return r},refresh:function(){var e=this._vector.layer;e&&e.drawFeature(this._vector)},show:function(){this._vector.style.display="block",this.refresh()},hide:function(){this._vector.style.display="none",this.refresh()},register:function(e,t){this._vector["_"+e]=t},unregister:function(e){this._vector["_"+e]=null},getPoints:function(){if(!this._vector)return[];if(this._vector.geometry&&this._vector.geometry instanceof OpenLayers.Geometry.Point)return NPMobile.Geometry.Point.getPoint(this._vector.geometry.x,this._vector.geometry.y);if(this._vector.geometry&&this._vector.geometry instanceof OpenLayers.Geometry.Polygon){for(var e=[],t=0;t<this._vector.geometry.components.length;t++){for(var r=this._vector.geometry.components[t].components,a=[],o=0;o<r.length;o++)a.push(NPMobile.Geometry.Point.getPoint(r[o].x,r[o].y));e.push(a)}return 1===e.length?e[0]:e}if(this._vector.geometry&&this._vector.geometry instanceof OpenLayers.Geometry.LineString){for(var n=this._vector.geometry.components,i=[],o=0;o<n.length;o++)i.push(NPMobile.Geometry.Point.getPoint(n[o].x,n[o].y));return i}},getLength:function(){return this._vector.geometry.getLength()},getArea:function(){return this._vector.geometry.getArea()}},NPMobile.Layers.CustomerLayer=function(e){NPMobile.Layers.Layer.call(this,e),this._layer=new OpenLayers.Layer.Vector(e||"默认图层1",{rendererOptions:{zIndexing:!0}}),this._layer.events.register("featureclick",this,function(e){e.feature._click&&e.feature._click.call(e.feature.data)})},NPMobile.Layers.CustomerLayer.prototype={addOverlay:function(e){this._layer.addFeatures(e._vector)},removeOverlay:function(e){this._layer.removeFeatures(e._vector,{silent:!0})},removeAllOverlays:function(){this._layer.removeAllFeatures()}},NPMobile.inherits(NPMobile.Layers.CustomerLayer,NPMobile.Layers.Layer),NPMobile.Geometry.ClusterMarker=function(e,t,r){this._point=e,this._clientData=r,this.showMarker=t,this._visible=!0;var a=NPMobile.T.setPoint(this._map,e);this.geometry={x:a.lon,y:a.lat}},NPMobile.Geometry.ClusterMarker.prototype={getClientData:function(){return this._clientData},getData:function(){var e=this._clientData||{};return e._visible=this._visible,e},changeStyle:function(e){if(this._apiObj){for(var t in e)this._apiObj.style[t]=e[t];this._apiObj.layer.drawFeature(this._apiObj)}}},NPMobile.Layers.ClusterLayer=function(e,t){NPMobile.Layers.Layer.call(this,e,t),this._events={_getUrl:function(){return"img/Flag.png"},_getImageSize:function(){return{w:32,h:32}},_getContent:function(){return""}},t=NPMobile.Util.extend(t,{distance:200,clusterClickModel:"zoom",isAsynchronous:!1,zIndexing:!0,defaultStyle:{fontColor:"white",fontSize:""}}),t.defaultStyle.fontColor=t.fontColor||t.defaultStyle.fontColor,t.defaultStyle.fontSize=t.fontSize||t.defaultStyle.fontSize;for(var r=this,a={isClusterLayer:!0,eventListeners:{featureselected:function(e){var t=e.feature;if(!t.data.isStatistics){t.layer;if(!(t.cluster&&t.cluster.length>1)){var a;return t.cluster?(t.cluster&&1===t.cluster.length&&(a=t.cluster[0]),t.cluster&&0===t.cluster.length&&(t.data.feature._apiObj=t,a=t.data.feature)):a=t.data,(!t.cluster||t.cluster.length<2)&&a&&!t.data.isStatistics&&r._trigger("click",a.id,""===e.feature.style.externalGraphic||"undefined"==typeof e.feature.style.externalGraphic),!1}}}}},o=[],n=t.statistics||[],i=n.length-1;i>=0;i--){var s=NPMobile.T.setPoint(null,{lon:n[i].x,lat:n[i].y});o.push({x:s.lon,y:s.lat,label:n[i].label})}var l=new OpenLayers.Strategy.AnimatedCluster({statistics:o,threshold:t.threshold||5,distance:t.distance||200,animationMethod:OpenLayers.Easing.Expo.easeOut,animationDuration:10,maxZoom:t.maxZoom||15,minZoom:t.minZoom||0,isAsynchronous:t.isAsynchronous,clusterClickModel:t.clusterClickModel,minClusterCount:t.minClusterCount,callbackFun:null});a.strategies=[l],a.rendererOptions={zIndexing:!0};var c={context:{getCount:function(e){return e.getCount()||r._trigger("getContent",e)},getUrl:function(e){return r._trigger("getUrl",e.getCount(),e.getData())},getWidth:function(e){return r._trigger("getImageSize",e.getCount(),e.getData()).w},getHeight:function(e){return r._trigger("getImageSize",e.getCount(),e.getData()).h},getRotation:function(e){return r._trigger("getRotation",e.getCount(),e.getData())},getgraphicYOffset:function(e){var t=e.getCount(),a=r._trigger("getImageSize",t,e.getData());return""==t?-a.h/2:-a.h},getlabelYOffset:function(e){var a=e.getCount(),o=e.getData(),n=r._trigger("getImageSize",a,o);return a?n.h/2:t.customLabelOffset?t.customLabelOffset.h:r._trigger("getCustomLabelOffset",a,o)},getLabelFontColor:function(e){var r=e.getCount();return r?t.defaultStyle.fontColor:t.defaultStyle.customLabelFontColor||t.defaultStyle.fontColor},getFontSize:function(e){var r=e.getCount();return r?t.defaultStyle.fontSize:t.defaultStyle.customLabelFontColor||t.defaultStyle.fontSize},getlabelXOffset:function(e){var r=e.getCount();if(!r&&t.customLabelOffset)return t.customLabelOffset.w},getTitle:function(e){var t=e.getCount(),a=!t&&r._trigger("getTitle",e.getData());return a||""},getlabelbg:function(e){var t=e.getCount();return!t&&r._trigger("getBackGroundColor",e.getData())}}};a.styleMap=new OpenLayers.StyleMap({default:new OpenLayers.Style({externalGraphic:"${getUrl}",graphicWidth:"${getWidth}",graphicHeight:"${getHeight}",graphicOpacity:1,graphicYOffset:"${getgraphicYOffset}",label:"${getCount}",labelYOffset:"${getlabelYOffset}",labelXOffset:"${getlabelXOffset}",labelSelect:!0,fontColor:"${getLabelFontColor}",fontSize:"${getFontSize}",rotation:"${getRotation}",labelBackgroundColor:"${getlabelbg}",title:"${getTitle}"},c)}),this._layer=new OpenLayers.Layer.Vector(e||"聚合图层",a)},NPMobile.Layers.ClusterLayer.prototype={_markers:[],display:function(e){this._layer.display(e)},_trigger:function(e){var t=this._events["_"+e];if(t){for(var r=[],a=1;a<arguments.length;a++)r.push(arguments[a]);return t.apply(this,r)}},unregister:function(e){return this._events["_"+e]=null,this},register:function(e,t){return this._events["_"+e]=t,this},addOverlays:function(e,t){for(var r=0;r<e.length;r++)this._layer.showMarker[e[r].markType]||(this._layer.showMarker[e[r].markType]=!0),this._markers.push(e[r]);t&&(this._layer.removeAllFeatures(),this._layer.events.triggerEvent("beforefeaturesadded",{features:this._markers.slice()}))}},NPMobile.inherits(NPMobile.Layers.ClusterLayer,NPMobile.Layers.Layer),NPMobile.Geometry.MultiLineString=function(){},NPMobile.inherits(NPMobile.Geometry.MultiLineString,NPMobile.Geometry.Curve),NPMobile.Geometry.LineString=function(e,t){NPMobile.Geometry.Curve.call(e,t),t=NPMobile.Util.extend(t,{graphicName:"triangle",strokeColor:"red",strokeWidth:2,strokeDashstyle:"solid",pointRadius:6,strokeLinecap:"round"});var r=new OpenLayers.Geometry.LineString(this._castPoints(NPMobile.T.setPoints(this._map,e)));this._vector=new OpenLayers.Feature.Vector(r,this,t)},NPMobile.inherits(NPMobile.Geometry.LineString,NPMobile.Geometry.Curve),NPMobile.Geometry.Polygon=function(e,t){NPMobile.Geometry.Curve.call(e,t),t=NPMobile.Util.extend(t,{fill:!0,fillColor:"red",fillOpacity:1,strokeColor:"#ee9900",strokeWidth:1,strokeOpacity:1,pointRadius:6,label:""}),e=NPMobile.T.setPoints(null,e);var r=new OpenLayers.Geometry.LinearRing(this._castPoints(e)),a=new OpenLayers.Geometry.Polygon(r);this._vector=new OpenLayers.Feature.Vector(a,this,t)},NPMobile.inherits(NPMobile.Geometry.Polygon,NPMobile.Geometry.Curve),NPMobile.Geometry.MultiPolygon=function(){},NPMobile.inherits(NPMobile.Geometry.MultiPolygon,NPMobile.Geometry.Curve),NPMobile.Geometry.Point=function(e,t){this.lon=Number(e),this.lat=Number(t)},NPMobile.Geometry.Point.setPoint=function(e,t){return NPMobile.T.setPoint(null,{lon:e,lat:t})},NPMobile.Geometry.Point.getPoint=function(e,t){return NPMobile.T.getPoint(null,{lon:e,lat:t})},NPMobile.Geometry.Marker=function(e,t){NPMobile.Geometry.Curve.call(this,e);var r={graphicWidth:t.graphicWidth,graphicHeight:t.graphicHeight,graphicXOffset:t.graphicXOffset,graphicYOffset:t.graphicYOffset,externalGraphic:t.externalGraphic,graphicZIndex:t.graphicZIndex},a=NPMobile.T.setPoint(this._map,e);this._vector=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.lon,a.lat),this,r)},NPMobile.Geometry.Marker.prototype={setStyle:function(e){for(var t in e)this._vector.style[t]=e[t];this.refresh()}},NPMobile.inherits(NPMobile.Geometry.Marker,NPMobile.Geometry.Curve),NPMobile.Map=function(e,t){this._events=[],this._selectControl=null,this._layers=[],t.mapOpts.controls=[new OpenLayers.Control.TouchNavigation({dragPanOptions:{enableKinetic:!0}}),new OpenLayers.Control.ScaleLine({bottomOutUnits:""})],t.mapOpts.centerPoint=t.mapOpts.centerPoint||t.vectorLayer[0].layerOpt.centerPoint,t.mapOpts.zoom=t.mapOpts.defaultZoom||t.mapOpts.minZoom,t.mapOpts.originCenter=t.mapOpts.centerPoint,this._map=new OpenLayers.Map(e,t.mapOpts);if(this._mapJson={map:this._map,vectorLayer:this._getLayers(t.vectorLayer),sattilateLayer:this._getLayers(t.sattilateLayer)},this._map.addLayers(this._mapJson.vectorLayer),this._defaultLayer=new OpenLayers.Layer.Vector("_默认图层",{rendererOptions:{zIndexing:!0}}),this._map.addLayers([this._defaultLayer]),"EPSG:900913"===this._map.getProjection()&&t.mapOpts.centerPoint[0]<180){var r=NPMobile.T.setPoint(this._map,{lon:t.mapOpts.centerPoint[0],lat:t.mapOpts.centerPoint[1]});this._map.originCenter=[r.lon,r.lat]}this.fullExtent(t.mapOpts.zoom),this._defaultLayer.events.register("featureclick",this,function(e){e.feature._click&&e.feature._click(e.feature)}),NPMobile.T.map=this._map},NPMobile.Map.prototype={setBaiduTrafficLayerVisable:function(e){if(2==this._mapJson.vectorLayer.length)for(var t=this._mapJson.vectorLayer.length-1;t>=0;t--)if("trafficLayer"===this._mapJson.vectorLayer[t].name){this._mapJson.vectorLayer[t].setVisibility(e);break}},distance:function(e,t){return e=new OpenLayers.Geometry.Point(e.lon,e.lat),t=new OpenLayers.Geometry.Point(t.lon,t.lat),e=e.transform("EPSG:4326","EPSG:900913"),t=t.transform("EPSG:4326","EPSG:900913"),Number(e.distanceTo(t).toFixed(2))},destroy:function(){this._map.destroy(),window.NPMobileHelper._map=null,window.NPMobileHelper._objs={}},donothing:function(){},register:function(e,t){if("click"===e&&t){var r=function(e){try{t(NPMobile.T.getPoint(this,this.getLonLatFromLayerPx(e.xy)))}catch(e){}return!1};this._events["_"+e]=r,this._map.events.register("click",this._map,r)}else this._events["_"+e]=t},addOverlay:function(e){this._defaultLayer.addFeatures([e._vector])},unregister:function(e){"click"===e&&this._map.events.unregister("click",this._map,this._events["_"+e]),this._events["_"+e]=null},getMinZoom:function(){return this._map.minZoom},getMaxZoom:function(){return this._map.maxZoom},addLayer:function(e){this._map.addLayers([e._layer]),this._layers.push(e._layer),this._selectControl?this._selectControl.setLayer(this._layers):(this._selectControl=new OpenLayers.Control.SelectFeature(this._layers,{autoActivate:!0,onSelect:function(e){e._click&&e._click(e.data.id)}}),this._map.addControl(this._selectControl))},fullExtent:function(e){var t=this._map.originCenter,r=new OpenLayers.LonLat(t[0],t[1]);e=e||this._map.minZoom,this._map.setCenter(r,e)},_getLayers:function(e){for(var t=function(e){var t=this.map.getResolution(),r=this.map.getMaxExtent().top,a=this.map.getMaxExtent().left,o=Math.round((e.left-a)/(t*this.tileSize.w)),n=Math.round((r-e.top)/(t*this.tileSize.h)),i=this.map.getZoom(),s=""+i+"/"+o+"/"+n+"."+this.type;this.isOnline&&(s="L="+i+"&X="+o+"&Y="+n);var l=this.url;return l instanceof Array&&(l=this.selectUrl(s,l)),l+s},r=[],a=0;a<e.length;a++){var o=e[a],n=null;if("NPMapLib.Layers.NPLayer"===o.layerType){var i=o.layerOpt.url+"/getTile?",s=o.layerOpt.layerInfo;switch(o.layerOpt.layerInfo.layerType){case"tiandi":case"NPMapLib.Layers.TDMapLayer":s._opts={mapType:s.type,centerPoint:s.centerPoint,fullExtent:s.fullExtent,topLevel:0,bottomLevel:18,isBaseLayer:!0,zoomOffset:0},s._opts.fullExtent=[-180,-90,180,90],n=new OpenLayers.Layer.TDTLayer(s.name,i,s._opts);break;case"gaode":case"NPMapLib.Layers.GaoDeLayer":s._opts={centerPoint:s.centerPoint,fullExtent:s.fullExtent,isBaseLayer:s.isBaseLayer},n=new OpenLayers.Layer.gaode(i,s.name,s._opts);break;case"google":case"NPMapLib.Layers.GoogleOffLineLayer":s._opts={isOnline:!0,centerPoint:s.centerPoint,fullExtent:s.fullExtent,isBaseLayer:s.isBaseLayer},s._opts.getURL=t,n=new OpenLayers.Layer.TMS(i,s.name,s._opts);break;case"baidu":case"baiduVector":case"NPMapLib.Layers.BaiduTileLayer":i+="X=${x}&Y=${y}&L=${z}",s._opts={centerPoint:s.centerPoint,fullExtent:s.fullExtent,isBaseLayer:!0,tileOrigin:new OpenLayers.LonLat(0,0),maxResolution:262144,isVectorLayer:s.isVectorLayer},"baiduVector"===o.layerOpt.layerInfo.layerType&&(s._opts.isVectorLayer=!0,i+="&format=jsonp"),n=new OpenLayers.Layer.Baidu(o.layerName,i,s._opts);break;case"streetmap":case"NPMapLib.Layers.OSMLayer":i+="X=${x}&Y=${y}&L=${z}",n=new OpenLayers.Layer.OSM(i,s.name,{isChian:!1,centerPoint:s.centerPoint,isBaseLayer:s.isBaseLayer});break;case"pgis":case"NPMapLib.Layers.EzMapTileLayer":i+="X=${x}&Y=${y}&L=${z}",s.tileOrigin=s.tileOrigin||new OpenLayers.LonLat(0,0),s.maxResolution=2,n=new OpenLayers.Layer.TMS_PGIS(i,s.name,s);break;case"NPMapLib.Layers.QQMapLayer":n=new OpenLayers.Layer.QQMap(i,s.name,s)}}else{var i=o.layerOpt.url,s=o.layerOpt;switch(o.layerType){case"NPMapLib.Layers.GoogleMapTileLayer":n=new OpenLayers.Layer.OSM(o.layerName,i,s);break;case"NPMapLib.Layers.TDMapLayer":s.fullExtent=[-180,-90,180,90],n=new OpenLayers.Layer.TDTLayer(o.layerName,i,s);break;case"NPMapLib.Layers.GaoDeLayer":n=new OpenLayers.Layer.gaode(o.layerName,i,s);break;case"NPMapLib.Layers.BaiduTileLayer":s.tileOrigin=new OpenLayers.LonLat(0,0),s.maxResolution=262144,s.isVectorLayer,n=new OpenLayers.Layer.Baidu(o.layerName,i,s);break;case"NPMapLib.Layers.QQMapLayer":n=new OpenLayers.Layer.QQMap(o.layerName,i,s);break;case"NPMapLib.Layers.OSMLayer":n=new OpenLayers.Layer.OSM(o.layerName,i,s);break;case"NPMapLib.Layers.ArcgisTileLayer":var l=o.layerOpt.layerInfo,c=l.tileInfo,s={};if(c.lods){s.resolutions=[];for(var a=0;a<c.lods.length;a++)s.resolutions.push(c.lods[a].resolution)}c.rows&&(s.tileSize=new OpenLayers.Size(c.rows,c.rows)),c.origin&&(s.tileOrigin=new OpenLayers.LonLat(c.origin.x,c.origin.y)),l.fullExtent&&(s.maxExtent=new OpenLayers.Bounds(l.fullExtent.xmin,l.fullExtent.ymin,l.fullExtent.xmax,l.fullExtent.ymax)),c.spatialReference&&(s.projection="EPSG:"+c.spatialReference.wkid),c.format&&(s.type="jpg"),n=new OpenLayers.Layer.ArcGISCache(o.layerName,i,s)}}r.push(n)}return r},showVectorLayer:function(e){if(this._mapJson&&this._mapJson.vectorLayer){if(this._mapJson.vectorLayer.length>1)for(var t=0;t<this._mapJson.vectorLayer.length;t++)this._mapJson.vectorLayer[t].show(),this._mapJson.vectorLayer[t].setZIndex(this._mapJson.vectorLayer[0].getZIndex()+t+1);if(this._mapJson.sattilateLayer.length>1)for(var t=this._mapJson.sattilateLayer.length-1;t>=1;t--)this._mapJson.sattilateLayer[t].hide();this._mapJson.vectorLayer.length>0&&this._mapJson.map.setBaseLayer(this._mapJson.vectorLayer[0])}},showSattilateLayer:function(e){if(this._mapJson&&this._mapJson.sattilateLayer){if(this._mapJson.sattilateLayer.length>1)for(var t=this._mapJson.sattilateLayer.length-1;t>=1;t--)this._mapJson.sattilateLayer[t].show(),this._mapJson.sattilateLayer[t].setZIndex(this._mapJson.sattilateLayer[0].getZIndex()+t+1);if(this._mapJson.vectorLayer.length>1)for(var t=this._mapJson.vectorLayer.length-1;t>=1;t--)this._mapJson.vectorLayer[t].hide();this._mapJson.sattilateLayer.length>0&&this._mapJson.map.setBaseLayer(this._mapJson.sattilateLayer[0])}},getCenter:function(){var e=this._map.getCenter();return NPMobile.T.getPoint(this._map,e)},panTo:function(e){var t=NPMobile.T.setPoint(this._map,e);this._map.panTo(new OpenLayers.LonLat(t.lon,t.lat))},setCenter:function(e,t){var r=NPMobile.T.setPoint(this._map,e);this._map.setCenter(new OpenLayers.LonLat(r.lon,r.lat),t||this.getZoom())},setZoom:function(e){var t=this._map.getCenter();this._map.setCenter(t,e||this.getZoom())},getZoom:function(){return this._map.getZoom()},createMarker:function(e,t,r){var a={graphicWidth:t.graphicWidth,graphicHeight:t.graphicHeight,graphicXOffset:t.graphicXOffset,graphicYOffset:t.graphicYOffset,externalGraphic:t.externalGraphic,graphicZIndex:t.graphicZIndex},o=NPMobile.T.setPoint(this._map,e),n=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(o.lon,o.lat),{point:e,style:a},a);this._defaultLayer.addFeatures([n]),n._click=r}},function(){function t(e){var t,r,a,o="",i="",s="",l=0;if(a=/[^A-Za-z0-9\+\/\=]/g,!e||a.exec(e))return e;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do t=n.indexOf(e.charAt(l++)),r=n.indexOf(e.charAt(l++)),a=n.indexOf(e.charAt(l++)),s=n.indexOf(e.charAt(l++)),t=t<<2|r>>4,r=(15&r)<<4|a>>2,i=(3&a)<<6|s,o+=String.fromCharCode(t),64!=a&&(o+=String.fromCharCode(r)),64!=s&&(o+=String.fromCharCode(i));while(l<e.length);return o}function r(e){return"string"==typeof e}function a(e,a){isNaN(e)&&(e=t(e),e=isNaN(e)?0:e),r(e)&&(e=parseFloat(e)),isNaN(a)&&(a=t(a),a=isNaN(a)?0:a),r(a)&&(a=parseFloat(a)),this.lng=e,this.lat=a}var o=function(){var e=3.141592653589793,t=.006693421622965943,r=52.35987755982988,a=20037508.34,o=6378245,n={};return n.transform=function(r,a){r=parseFloat(r),a=parseFloat(a);var n={};if(this.outofChina(a,r))return n.lon=r,n.lat=a,n;var i=this.transformLat(r-105,a-35),s=this.transformLon(r-105,a-35),l=a/180*e,c=Math.sin(l);c=1-t*c*c;var u=Math.sqrt(c);i=180*i/(o*(1-t)/(c*u)*e),s=180*s/(o/u*Math.cos(l)*e);var p=a+i,h=r+s;return n.lon=h,n.lat=p,n},n.outofChina=function(e,t){return t<72.004||t>137.8347||(e<.8293||e>55.8271)},n.transformLat=function(t,r){var a=-100+2*t+3*r+.2*r*r+.1*t*r+.2*Math.sqrt(Math.abs(t));return a+=2*(20*Math.sin(6*t*e)+20*Math.sin(2*t*e))/3,a+=2*(20*Math.sin(r*e)+40*Math.sin(r/3*e))/3,a+=2*(160*Math.sin(r/12*e)+320*Math.sin(r*e/30))/3},n.transformLon=function(t,r){var a=300+t+2*r+.1*t*t+.1*t*r+.1*Math.sqrt(Math.abs(t));return a+=2*(20*Math.sin(6*t*e)+20*Math.sin(2*t*e))/3,a+=2*(20*Math.sin(t*e)+40*Math.sin(t/3*e))/3,a+=2*(150*Math.sin(t/12*e)+300*Math.sin(t/30*e))/3},n.gcj2wgs=function(e,t){var r={lon:0,lat:0},a=e-(this.transform(e,t).lon-e),o=t-(this.transform(e,t).lat-t);return r.lon=a,r.lat=o,r},n.bd_encrypt=function(e,t){var a=e,o=t,n=Math.sqrt(a*a+o*o)+2e-5*Math.sin(o*r),i=Math.atan2(o,a)+3e-6*Math.cos(a*r),s=n*Math.cos(i)+.0065,l=n*Math.sin(i)+.006;return{lon:s,lat:l}},n.bd_decrypt=function(e,t){var a=e-.0065,o=t-.006,n=Math.sqrt(a*a+o*o)-2e-5*Math.sin(o*r),i=Math.atan2(o,a)-3e-6*Math.cos(a*r),s=n*Math.cos(i),l=n*Math.sin(i);return{lon:s,lat:l}},n.webMoctorJW2PM=function(e,t){var r={lon:0,lat:0};e=parseFloat(e),t=parseFloat(t),r.lon=e/180*20037508.34,t>85.05112&&(t=85.05112),t<-85.05112&&(t=-85.05112),t=Math.PI/180*t;var a=Math.PI/4+t/2;return r.lat=20037508.34*Math.log(Math.tan(a))/Math.PI,r},n.inverseMercator=function(e,t){return e=180*e/a,t=180/Math.PI*(2*Math.atan(Math.exp(t/a*Math.PI))-Math.PI/2),{lon:e,lat:t}},n},n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i={$O:6370996.81,lG:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],Au:[75,60,45,30,15,0],fP:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],iG:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],p:null,JD:function(e,t,r){for(;e>r;)e-=r-t;for(;e<t;)e+=r-t;return e},ND:function(e,t,r){return null!=t&&(e=Math.max(e,t)),null!=r&&(e=Math.min(e,r)),e},Fb:function(e){if(e.lng=e.lon,e.lat=e.lat,!e||180<e.lng||-180>e.lng||90<e.lat||-90>e.lat)return new a(0,0);var t,r;e.lng=this.JD(e.lng,-180,180),e.lat=this.ND(e.lat,-74,74),t=new a(e.lng,e.lat);for(var o=0;o<this.Au.length;o++)if(t.lat>=this.Au[o]){r=this.iG[o];break}if(!r)for(o=this.Au.length-1;0<=o;o--)if(t.lat<=-this.Au[o]){r=this.iG[o];break}return e=this.gK(e,r),e=new a(e.lng,e.lat),new NPMobile.Geometry.Point(e.lng,e.lat)},gK:function(e,t){if(e&&t){var r=t[0]+t[1]*Math.abs(e.lng),o=Math.abs(e.lat)/t[9],o=t[2]+t[3]*o+t[4]*o*o+t[5]*o*o*o+t[6]*o*o*o*o+t[7]*o*o*o*o*o+t[8]*o*o*o*o*o*o,r=r*(0>e.lng?-1:1),o=o*(0>e.lat?-1:1);return new a(r,o)}},ToLL:function(e){e.lng=e.lon;for(var t,r=0;r<this.lG.length;r++)if(e.lat>=this.lG[r]){t=this.fP[r];break}return e=this.gK(e,t),new NPMobile.Geometry.Point(e.lng.toFixed(6),e.lat.toFixed(6))}},s=NPMobile.T={};s.Baidu=i;var l=new o,c=function(e){var t;return e._mapAdapter&&(t=e._mapAdapter.map.baseLayer),e.map&&(t=e.map.baseLayer),e.baseLayer&&(t=e.baseLayer),t};s.helper=l,s.setPoint=function(t,r){if(!NPMobile.ISPOINTCONVERT)return r;if(t=t||NPMobile.T.map,"EPSG:900913"==t.getProjection()){var a=c(t);return a.CLASS_NAME.indexOf("Baidu")!=-1?(e=l.transform(r.lon,r.lat),e=l.bd_encrypt(e.lon,e.lat),NPMobile.T.Baidu.Fb(e)):(e=a.CLASS_NAME.indexOf("OSM")!=-1&&0==a.isChina?r:l.transform(r.lon,r.lat),e=l.webMoctorJW2PM(e.lon,e.lat),new NPMobile.Geometry.Point(e.lon,e.lat))}return r},s.setPoints=function(e,t){for(var r=[],a=0;a<t.length;a++)r.push(NPMobile.T.setPoint(e,t[a]));return r},s.getPoint=function(e,t){if(!NPMobile.ISPOINTCONVERT)return t;if(e=e||NPMobile.T.map,t.lon>-180&&t.lon<180)return t;if("EPSG:900913"==e.getProjection()){var r=l.inverseMercator(t.lon,t.lat),a=c(e);return a.CLASS_NAME.indexOf("Baidu")!=-1?(r=NPMobile.T.Baidu.ToLL(t),r=l.bd_decrypt(r.lon,r.lat),r=l.gcj2wgs(r.lon,r.lat),new NPMobile.Geometry.Point(r.lon,r.lat)):(r=a.CLASS_NAME.indexOf("OSM")!=-1&&0==a.isChina?r:l.gcj2wgs(r.lon,r.lat),new NPMobile.Geometry.Point(r.lon,r.lat))}return t},s.getPoints=function(e,t){for(var r=[],a=0;a<t.length;a++)r.push(NPMobile.T.getPoint(e,t[a]));return r},s.setExtent=function(e,t){if("EPSG:900913"==e.getProjection()){var r=NPMobile.T.setPoint(e,{lon:t.left,lat:t.top}),a=NPMobile.T.setPoint(e,{lon:t.right,lat:t.bottom});return new NPMap.Geometry.Extent(r.lon,a.lat,a.lon,r.lat)}return t},s.getExtent=function(e,t){if("EPSG:900913"==e.getProjection()){var r=NPMobile.T.getPoint(e,{lon:t.left,lat:t.top}),a=NPMobile.T.getPoint(e,{lon:t.right,lat:t.bottom});return new NPMap.Geometry.Extent(r.lon,a.lat,a.lon,r.lat)}return t}}(),window.NPMobileHelper={_map:null,_objs:{},_createClass:function(e){if(e.id&&this._objs[e.id])return this._objs[e.id];var t=null;switch(e.className){case"NPMobile.Tool.Measure":t=new NPMobile.Tool.Measure(this._objs[e.map.id]);break;case"NPMobile.Layers.CustomerLayer":t=new NPMobile.Layers.CustomerLayer(e.name);break;case"NPMobile.Geometry.Marker":t=new NPMobile.Geometry.Marker(e.point,e.options);break;case"P":case"NPMobile.Geometry.Point":return t=new NPMobile.Geometry.Point(e.lon,e.lat);case"NPMobile.Map":"string"==typeof e.mapConfig&&($.ajaxSettings.async=!1,$.getJSON(e.mapConfig+"?v="+(new Date).getTime(),function(t,r){e.mapConfig=t})),t=new NPMobile.Map(e.mapContainer||"viewerContainer",e.mapConfig),window.NPMobileHelper._map=t;break;case"NPMobile.Layers.ClusterLayer":e.options.minZoom=e.options.minZoom||window.NPMobileHelper._map.getMinZoom()+1,e.options.maxZoom=e.options.maxZoom||window.NPMobileHelper._map.getMaxZoom(),e.options.selectZoom=e.options.selectZoom||window.NPMobileHelper._map.getMaxZoom(),t=new NPMobile.Layers.ClusterLayer(e.name,e.options),t.register("getUrl",function(t,r){return""!=t?e.options.clusterImage.url:r.getData().image.url||e.options.singleImage.url}),t.register("getImageSize",function(t,r){return""!=t?e.options.clusterImage.imageSize:r.getData().image.imageSize||e.options.singleImage.imageSize}),t.register("getContent",function(){return""});break;case"_CM":case"NPMobile.Geometry.ClusterMarker":t=new NPMobile.Geometry.ClusterMarker(e.point,null,e);break;case"NPMobile.Geometry.Polygon":t=new NPMobile.Geometry.Polygon(e.points,e.style)}return t.id=e.id,this._objs[e.id]=t,t},callMethod:function(){for(var e=Array.prototype.slice.call(arguments),t=e.shift(),r=this._objs[t.id]||this._createClass(t),a=[],o=1;o<e.length;o++)if("object"==typeof e[o]&&e[o].className)a.push(this._createClass(e[o]));else if(Array.isArray(e[o])){for(var n=[],i=0;i<e[o].length;i++){var s=e[o][i];"object"==typeof s&&s.className?n.push(this._createClass(s)):n.push(s)}a.push(n)}else a.push(e[o]);if("register"===e[0]||"unregister"===e[0])return r[e[0]](a[0],function(){var e={id:r.id,eventType:a[0],args:Array.prototype.slice.call(arguments)};window.WebViewJavascriptBridge.callHandler("NPMobileHelper.Event.Call",e,function(e){})}),"";var l=r[e[0]].apply(r,a);return JSON.stringify(l)}},NPMobile.Tool={MeasureMode:{DISTANCE:"Path",AREA:"Polygon"}},NPMobile.Tool.Measure=function(e){var t={Point:{pointRadius:4,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:.5,strokeOpacity:1,strokeColor:"red",cursor:"inherit"},Line:{strokeWidth:1.5,strokeOpacity:1,strokeColor:"#ff0000"},Polygon:{strokeWidth:1.5,strokeOpacity:1,fillOpacity:.3,fillColor:"yellow",strokeColor:"#ff0000"}},r=new OpenLayers.Style;r.addRules([new OpenLayers.Rule({symbolizer:t})]);var a=new OpenLayers.StyleMap({default:r});this._measureControls={Path:new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{displayUnits:"km",geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:a}}}),Polygon:new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{displayUnits:"km",persist:!1,geodesic:!0,handlerOptions:{layerOptions:{styleMap:a}}})},this._measureLayer=new OpenLayers.Layer.Vector("__绘制图层",{rendererOptions:{zIndexing:!0},eventListeners:{featureselected:function(e){if(e.feature&&e.feature.data&&e.feature.data.current){var t=e.feature.data.current;t.layer.removeFeatures(t.vectors),t.vectors=[]}}}}),this._map=e._map,e.addLayer({_layer:this._measureLayer})},NPMobile.Tool.Measure.prototype={setMode:function(e,t){var r=this._measureControls[e];if(r){for(var a in this._measureControls)this._map.removeControl(this._measureControls[a]);this._map.addControl(r),r.activate();var o={vectors:[],layer:this._measureLayer,map:this._map,success:function(e){r.deactivate(),this.map.removeControl(r),t&&t(e)}};r.events.listeners={},r.events.on({scope:this,measure:function(e){this._measure(e,o)},measurepartial:function(e){this._measureProcess(e,o)}})}},_measure:function(e,t){if(0!==e.measure){var r=[],a=e.geometry,o={pointRadius:4,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1.5,strokeOpacity:1,strokeColor:"red"},n=a.components[a.components.length-2],i=a.components[a.components.length-1],s={km:"千米",m:"米"};if(1===e.order){e.measure>=1e3?iconUrl="110_15.gif":e.measure>=100?iconUrl="100_15.gif":e.measure>=10?iconUrl="90_15.gif":iconUrl="80_15.gif";var l=iconUrl.substring(0,iconUrl.indexOf(".")).split("_"),c={width:20,height:10},u=n.x<i.x?(c.width+Number(l[0]))/2:(-c.width-Number(l[0]))/2,p=0,o={label:"总长"+e.measure.toFixed(1)+s[e.units],fontSize:12,fontColor:"red",fontFamily:"宋体",labelXOffset:0+u,labelYOffset:8+p,graphicWidth:Number(l[0]),graphicHeight:Number(l[1]),externalGraphic:OpenLayers.Util.getImageLocation(iconUrl),graphicXOffset:-Number(l[0])/2+u,graphicYOffset:-Number(l[1])},h=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(i.x,i.y),h,o);if(t.vectors.push(h),a.components.length>0)for(var y=0;y<a.components.length;y++)r.push(new OpenLayers.Geometry.Point(a.components[y].x,a.components[y].y));var f=new OpenLayers.Geometry.MultiPoint(r);multiFeature=new OpenLayers.Feature.Vector(f,null,{pointRadius:4,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1.5,strokeOpacity:1,strokeColor:"red"}),t.vectors.push(multiFeature),o={graphicWidth:12,graphicHeight:12,graphicXOffset:u+Number(l[0])/2+(n.x<i.x?0:-8),graphicYOffset:-Number(l[1])},o.externalGraphic=OpenLayers.Util.getImageLocation("close.gif"),h=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(i.x,i.y),{current:t},o),t.vectors.push(h),h=new OpenLayers.Feature.Vector(a.clone(),h,{strokeColor:"red",strokeLinecap:"round"}),t.vectors.push(h)}else{label=parseFloat(e.measure).toFixed(2)+"平方"+s[e.units];var r=[];if(a.components.length>0&&a.components[0].components.length>0)for(var g=0;g<a.components[0].components.length;g++){var m=a.components[0].components[g];r.push(new OpenLayers.Geometry.Point(m.x,m.y))}f=new OpenLayers.Geometry.MultiPoint(r),multiFeature=new OpenLayers.Feature.Vector(f,null,o),t.vectors.push(multiFeature),o={strokeWidth:1.5,strokeOpacity:1,fillOpacity:.3,fillColor:"yellow",strokeColor:"#ff0000"},multiFeature=new OpenLayers.Feature.Vector(e.geometry.clone(),null,o),t.vectors.push(multiFeature);var L=e.geometry.getBounds(),b=L.getCenterLonLat();e.measure>=1e3?iconUrl="110_15.gif":e.measure>=100?iconUrl="100_15.gif":e.measure>=10?iconUrl="90_15.gif":iconUrl="80_15.gif";
var l=iconUrl.substring(0,iconUrl.indexOf(".")).split("_"),p=1.5,o={label:label,fontSize:12,fontColor:"red",fontFamily:"宋体",labelXOffset:0,labelAlign:"cb",labelYOffset:4,fontWeight:"bold",labelSelect:!0,externalGraphic:OpenLayers.Util.getImageLocation(iconUrl),graphicXOffset:-Number(l[0])/2,graphicYOffset:-Number(l[1]),graphicWidth:Number(l[0]),graphicHeight:Number(l[1])};h=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(b.lon,L.top),null,o),t.vectors.push(h),o={graphicWidth:12,graphicHeight:12,graphicXOffset:Number(l[0])/2,graphicYOffset:-Number(l[1])},o.externalGraphic=OpenLayers.Util.getImageLocation("close.gif"),h=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(b.lon,L.top),{current:t},o),t.vectors.push(h)}t.layer.addFeatures(t.vectors),t.success({measure:e.measure.toFixed(1),unit:(1==e.order?"":"平方")+s[e.units]})}},_measureProcess:function(e,t){if(1===e.order){var r={km:"千米",m:"米"},a=(e.measure.toFixed(1)+r[e.units],{pointRadius:4,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1.5,strokeOpacity:1,strokeColor:"red",fontSize:12,fontColor:"red",fontFamily:"宋体"});"0.0"===e.measure.toFixed(1)&&(a.label="起点",a.labelXOffset=31,a.labelYOffset=4,a.externalGraphic=OpenLayers.Util.getImageLocation("35_15.gif"),a.graphicHeight=15,a.graphicWidth=35,a.graphicXOffset=15,a.graphicYOffset=-10);var o=new OpenLayers.Feature.Vector(e.geometry.components[e.geometry.components.length-1].clone(),null,a);t.vectors.push(o),t.layer.addFeatures([o])}},remove:function(){for(var e in this._measureControls)this._map.removeControl(this._measureControls[e]);this._measureLayer.removeAllFeatures(),this._map.removeLayer(this._measureLayer)}};